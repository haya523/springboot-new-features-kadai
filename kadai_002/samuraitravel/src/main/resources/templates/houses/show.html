<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <div th:replace="~{fragment :: meta}"></div>
  <div th:replace="~{fragment :: styles}"></div>
  <title>民宿詳細</title>
</head>
<body>
  <div class="samuraitravel-wrapper">
    <!-- ヘッダー -->
    <div th:replace="~{fragment :: header}"></div>

    <main>
      <div class="container pt-4 pb-5 samuraitravel-container">
        <div class="row justify-content-center">
          <div class="col-xl-6 col-lg-7 col-md-9">

            <nav class="mb-4" style="--bs-breadcrumb-divider:'>';" aria-label="breadcrumb">
              <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a th:href="@{/}">ホーム</a></li>
                <li class="breadcrumb-item"><a th:href="@{/houses}">民宿一覧</a></li>
                <li class="breadcrumb-item active" aria-current="page">民宿詳細</li>
              </ol>
            </nav>

            <h1 class="mb-4 text-center" th:text="${house.name}">民宿名</h1>

            <div class="mb-3">
              <img th:if="${house.imageName}" th:src="@{/storage/__${house.imageName}__}" class="w-100" alt="民宿画像">
              <img th:unless="${house.imageName}" th:src="@{/images/noImage.png}" class="w-100" alt="NO IMAGE">
            </div>

            <!-- 基本情報 -->
            <div class="container mb-4">
              <div class="row pb-2 mb-2 border-bottom">
                <div class="col-4 fw-bold">説明</div>
                <div class="col"><span class="samuraitravel-pre-wrap" th:text="${house.description}"></span></div>
              </div>
              <div class="row pb-2 mb-2 border-bottom">
                <div class="col-4 fw-bold">宿泊料金</div>
                <div class="col"><span th:text="${#numbers.formatInteger(house.price,1,'COMMA')}"></span>円</div>
              </div>
              <div class="row pb-2 mb-2 border-bottom">
                <div class="col-4 fw-bold">定員</div>
                <div class="col"><span th:text="${house.capacity}"></span>人</div>
              </div>
              <div class="row pb-2 mb-2 border-bottom">
                <div class="col-4 fw-bold">郵便番号</div>
                <div class="col"><span th:text="${house.postalCode}"></span></div>
              </div>
              <div class="row pb-2 mb-2 border-bottom">
                <div class="col-4 fw-bold">住所</div>
                <div class="col"><span th:text="${house.address}"></span></div>
              </div>
              <div class="row pb-2 mb-2 border-bottom">
                <div class="col-4 fw-bold">電話番号</div>
                <div class="col"><span th:text="${house.phoneNumber}"></span></div>
              </div>
            </div>

            <!-- ===== レビュー ===== -->
            <section class="mt-4">
              <h2>レビュー</h2>

              <!-- 0件 -->
              <div th:if="${reviews == null or #lists.isEmpty(reviews)}">レビューはありません。</div>

              <!-- 先頭表示（Controller側で3件など） -->
              <ul th:if="${reviews != null}">
                <li th:each="r : ${reviews}">
                  <span th:utext="${'&#9733;'.repeat(r.rating)}"></span>
                  <span th:utext="${'&#9734;'.repeat(5 - r.rating)}"></span>
                  ：<span th:text="${r.comment}">コメント</span>

                  <!-- ▼ 自分のレビュー行だけ 編集/削除（重複防止） -->
                  <span th:if="${myReview != null and myReview.id == r.id}" style="margin-left:.5rem">
                    <a th:href="@{/reviews/{id}/edit(id=${r.id})}">編集</a>
                    <form th:action="@{/reviews/{id}/delete(id=${r.id})}" method="post" style="display:inline">
                      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                      <button type="submit">削除</button>
                    </form>
                  </span>
                </li>
              </ul>

              <!-- ▼ 一覧へのリンクは常に表示 -->
              <div class="mb-2">
                <a th:href="@{/reviews/house/{hid}(hid=${house.id})}">他のレビューも見る</a>
              </div>

              <!-- ▼ ログイン済みで未投稿時のみ 投稿ボタン -->
              <div sec:authorize="isAuthenticated()" th:if="${myReview == null}" class="mt-2">
                <a th:href="@{/reviews/house/{hid}/new(hid=${house.id})}"
                   class="btn text-white shadow-sm samuraitravel-btn">
                  レビューを投稿する
                </a>
              </div>

              <!-- ▼ 未ログイン時だけ：ログイン後この詳細に戻す -->
              <div sec:authorize="!isAuthenticated()" class="mt-2">
                <a th:href="@{/login(redirect=${'/houses/' + house.id})}"
                   class="btn text-white shadow-sm samuraitravel-btn">
                  ログインしてレビューを投稿
                </a>
              </div>
            </section>

          </div>
        </div>
      </div>
    </main>

    <!-- フッター -->
    <div th:replace="~{fragment :: footer}"></div>
  </div>

  <div th:replace="~{fragment :: scripts}"></div>

  <!-- Flatpickr（必要なページだけでOK） -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  <script th:src="@{/js/flatpickr.js}"></script>
</body>
</html>
